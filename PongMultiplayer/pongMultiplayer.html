<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Pong Multiplayer</title>
    <style>
        * { padding: 0; margin: 0; }
        canvas {
            background: rgba(255, 255, 255, 0); 
            display: block; 
            margin: auto; 
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
        }
        div {
            background-color: #8a995a;
            background-image: url("https://www.transparenttextures.com/patterns/white-diamond-dark.png ");
            /* 
            https://www.transparenttextures.com/patterns/diagmonds.png
            https://www.transparenttextures.com/patterns/white-diamond-dark.png 
            */

        }
        body {
            background-color: #8a995a;
            background-image: url("https://www.transparenttextures.com/patterns/white-diamond-dark.png ");
        }

       
    </style>
</head>
<body>
    <div style = "text-align:center;">
        <canvas id="myCanvas" ></canvas>
        <p>Bottom paddle: arrow keys. Top paddle: A/D. Left paddle: O/L</p>
        <p>Right paddle: -/+.</p>
        Toggle resize: <button onclick="toggleRandomResize()">Resize</button> or spacebar.
        Toggle realtive rebounds: <input type="checkbox" id="myCheckRelative" onclick="checkRealtiveRebounds()">
        <p >Ball Pos (x,y): <span id="ballX"></span> <span id="ballY"></span></p>
        <p>Ball velocity (dx,dy): <span id="ballDx"></span> , <span id="ballDy"></span></p>
        <p >Status: <span id="status"></span></p>
        
    </div>

    <audio controls autoplay hidden>
        <source src="Retro_Arcade.mp3" type="audio/mpeg">
      Your browser does not support the audio element.
      <https://patrickdearteaga.com/arcade-music/>
      <https://www.dl-sounds.com/royalty-free/category/game-film/video-game/?_sfm_bpm=0+220/>
      </audio>

    <script>
        var canvas = document.getElementById("myCanvas");
        var ctx = canvas.getContext("2d");
        ctx.canvas.height = Math.round(Math.round((window.innerHeight*2/3))/10)*10;
        ctx.canvas.width = Math.round(Math.round((window.innerHeight*2/3))/10)*10;

        //Global ball attributes
        var ballSpeed = 2;  
        var defaultBallSpeed = ballSpeed;
        var ballRadius = 10;
        var paddleSpeed = 10;   //Note: paddle speed can only be 2, 5 or 10
        var speedRatio = Math.sqrt((ballSpeed*ballSpeed) + (ballSpeed*ballSpeed));
        var rand;
        var randAngleToggle = false;
        var relativeAngleReboundToggle = false;
        var randResizeToggle = false;
        var resizeAmount = 200;
        var resizeTick = resizeAmount;
        var resizePerTick = 1;
        var canvasSizeIncrease = false;
        var paddleHeight = 10;
        var paddleWidth = 70;   
        var defaultPaddleWidth = 70; //Note: must be multiple of 10
        var borderWidth = Math.round(Math.round(0.1 * canvas.width)/10)*10; //Round to whole number and round to nearest 10

        // Colours
        // https://www.reddit.com/r/coolguides/comments/njqt0x/color_combinations_that_go_well_with_each_other/

        // Balls
        var ball1 = {
            x: canvas.width*4/5,
            y: canvas.height/2,
            dx: -ballSpeed,
            dy: ballSpeed,
            colour: "#000000",
            owner: 'none',
            initialPos: true
        };

        var ball2 = {
            x: canvas.width*4/5,
            y: canvas.height/2,
            dx: -ballSpeed,
            dy: ballSpeed,
            colour: "#000000",
            owner: 'none',
            initialPos: true
        };

        //Powerups
        var powerup1 = {
            x: 10,
            y: 10,
            size: borderWidth/2,
            active: false,
            colourCounter: 10,
            colour: "#000000"
        };

        var powerup2 = {
            x: 10,
            y: 10,
            size: borderWidth/2,
            active: false,
            colourCounter: 10,
            colour: "#000000"
        };

        // Paddles
        var topPaddle = {
            x: Math.round(Math.round(((canvas.width/2)-(defaultPaddleWidth/2)))/10)*10,
            y: (canvas.height-defaultPaddleWidth)/2,
            width: defaultPaddleWidth,
            leftPress: false,
            rightPress: false,
            lives: 2,
            colour: "#FC1212"
        }

        var leftPaddle = {
            x: (canvas.width-defaultPaddleWidth)/2,
            y: Math.round(Math.round(((canvas.height-defaultPaddleWidth)/2))/10)*10,
            width: defaultPaddleWidth,
            upPress: false,
            downPress: false,
            lives: 2,
            colour: "#3CC01B"
        }

        var rightPaddle = {
            x: (canvas.width-defaultPaddleWidth)/2,
            y: Math.round(Math.round(((canvas.height-defaultPaddleWidth)/2))/10)*10,
            width: defaultPaddleWidth,
            upPress: false,
            downPress: false,
            lives: 2,
            colour: "#C072CC"
        }
        
        var bottomPaddle = {
            x: Math.round(Math.round(((canvas.width/2)-(defaultPaddleWidth/2)))/10)*10,
            y: ((canvas.height-defaultPaddleWidth)/2),
            width: defaultPaddleWidth,
            leftPress: false,
            rightPress: false,
            lives: 2,
            colour: "#0095DD"
        }
        

        //////////////////////////////////////////////////////// FUNCTIONS ///////////////////////////////////////////////////////

        function checkRealtiveRebounds() {
            //toggle checkbox
            var checkBoxRealtive = document.getElementById("myCheckRelative");
            relativeAngleReboundToggle = checkBoxRealtive.checked;
        }

        function toggleRandomResize() {
            randResizeToggle = true;
        }

        function resizeCanvas() {

            
            if(resizeTick > 0 && canvasSizeIncrease == false) {
                ctx.canvas.width -= resizePerTick;
                ctx.canvas.height -= resizePerTick;
                //draw(); 
                resizeTick -= 1;
                setTimeout(resizeCanvas, 10);
            }
            else if (resizeTick < resizeAmount){
                canvasSizeIncrease = true;
                ctx.canvas.width += resizePerTick;
                ctx.canvas.height += resizePerTick;
                // draw();
                resizeTick += 1;
                if(resizeTick == resizeAmount) return;
                setTimeout(resizeCanvas, 10);
                
            }
            else {
                canvasSizeIncrease = false;
            }
            
        }


        document.addEventListener("keydown", keyDownHandler, false);
        document.addEventListener("keyup", keyUpHandler, false);
        document.addEventListener("mousemove", mouseMoveHandler, false);

        function keyDownHandler(e) {
            //Bottom player
            if(e.key == "Right" || e.key == "ArrowRight") {
                bottomPaddle.rightPress = true;
            }
            
            else if(e.key == "Left" || e.key == "ArrowLeft") {
                bottomPaddle.leftPress = true;
            }

            //Top player
            if(e.key == "a") {
                topPaddle.leftPress = true;
            }       
            else if(e.key == "d") {
                topPaddle.rightPress = true;
            }

            //Left player
            if(e.key == "o") {
                leftPaddle.upPress = true;
            }
            else if(e.key == "l") {
                leftPaddle.downPress = true;
            }

            //Right player
            if(e.key == "-" ) {
                rightPaddle.upPress = true;
            }
            else if(e.key == "+") {
                rightPaddle.downPress = true;
            }

            //Resize
            if(e.key == " " ) {
                randResizeToggle = true;
            }
        }

        function keyUpHandler(e) {
            //Bottom player
            if(e.key == "Right" || e.key == "ArrowRight") {
                bottomPaddle.rightPress = false;
            }
            else if(e.key == "Left" || e.key == "ArrowLeft") {
                bottomPaddle.leftPress = false;
            }

            //Top player
            if(e.key == "a") {
                topPaddle.leftPress = false;
            }       
            else if(e.key == "d") {
                topPaddle.rightPress = false;
            }

            //Left player
            if(e.key == "o") {
                leftPaddle.upPress = false;
            }
            else if(e.key == "l") {
                leftPaddle.downPress = false;
            }

            //Right player
            if(e.key == "-" ) {
                rightPaddle.upPress = false;
            }
            else if(e.key == "+") {
                rightPaddle.downPress = false;
            }

            //Resize
            if(e.key == " " ) {
                randResizeToggle = false;
            }
        }
        

        function mouseMoveHandler(e) {
            var relativeX = e.clientX - canvas.offsetLeft;
            var relativeY = e.clientY - canvas.offsetTop;
            if(relativeX > 0 && relativeX < canvas.width) {
                //document.getElementById("xPosMouse").innerHTML = relativeX;
                bottomPaddle.x = Math.round(Math.round(relativeX - bottomPaddle.width/2)/10)*10;
                topPaddle.x = Math.round(Math.round(relativeX - topPaddle.width/2)/10)*10;
                
                

            }
            if(relativeY > 0 && relativeY < canvas.height) {
                //document.getElementById("yPosMouse").innerHTML = relativeY;
                leftPaddle.y = Math.round(Math.round(relativeY - leftPaddle.width/2)/10)*10;
                rightPaddle.y = Math.round(Math.round(relativeY - rightPaddle.width/2)/10)*10;
            }
        }

        function getRandomArbitrary(min, max) {
            return Math.random() * (max - min) + min;
        }
        
        function drawBorder() {
            ctx.beginPath();
            ctx.rect(borderWidth, borderWidth, canvas.width - 2*borderWidth, canvas.height - 2*borderWidth);
            ctx.fillStyle = "#000000";
            ctx.stroke();
            ctx.closePath();
        }

        function drawBall(ball) {
            //Ball 1
            //Have ball start in a random direction
            if(ball.initialPos == true) {

                ball.dx = getRandomArbitrary(0, speedRatio) * (Math.round(Math.random()) * 2 - 1);          
                ball.dy = Math.sqrt(speedRatio*speedRatio - ball.dx*ball.dx) * (Math.round(Math.random()) * 2 - 1);
                ball.x = canvas.height/2;
                ball.y = canvas.height/2;
            }
            ball.initialPos = false;
            ctx.beginPath();
            ctx.arc(ball.x, ball.y, ballRadius, 0, Math.PI*2);
            ctx.fillStyle = ball.colour;
            ctx.fill();
            ctx.closePath();

            ctx.beginPath();
            ctx.arc(ball.x, ball.y, ballRadius, 0, Math.PI*2);
            ctx.stroke();
            ctx.closePath();

            document.getElementById("ballX").innerHTML = Math.round(ball.x * 100) / 100;
            document.getElementById("ballY").innerHTML = Math.round(ball.y * 100) / 100;
        }

        function drawPowerup(powerup) {
            if(powerup.active == false) {
                //Set coords
                powerup.x = getRandomArbitrary(2*borderWidth, canvas.height - 2*borderWidth);
                powerup.y = getRandomArbitrary(2*borderWidth, canvas.height - 2*borderWidth);

                powerup.active = true;
                
            }
            
            var randomColor;
            if(powerup.colourCounter == 10) {
                randomColor = Math.floor(Math.random()*16777215).toString(16);
                powerup.colour = "#" + randomColor;
                powerup.colourCounter = 0;
            }
            ctx.fillStyle = powerup.colour;
            ctx.fillRect(powerup.x, powerup.y, powerup.size, powerup.size);   
            powerup.colourCounter++;      

            ctx.beginPath();
            ctx.rect(powerup.x, powerup.y, powerup.size, powerup.size);
            ctx.fillStyle = "#000000";
            ctx.stroke();
            ctx.closePath();

            var size = powerup.size + 5;
            var font = size + "px serif";
            ctx.font = font;
            ctx.textAlign = "center";
            ctx.fillText('?', powerup.x + powerup.size/2, powerup.y + powerup.size - 3);
            
        }

        function givePowerup(ball) {
            //Get the owner
            var owner;
            //alert(ball.owner);
            if(ball.owner == 'top') {
                deployPowerup(topPaddle);
            }
            else if (ball.owner == 'left') {
                deployPowerup(leftPaddle);
            }
            else if (ball.owner == 'right') {
                deployPowerup(rightPaddle);
            }
            else if (ball.owner == 'bottom') {
                deployPowerup(bottomPaddle);
            }
            else return;

            
            
        }

        function deployPowerup(paddle) {
            //Pick a random powerup
            var rand = Math.floor(Math.random() * 4);  //0 - 4

            if(rand == 0) {
                if(paddle.width < 2*defaultPaddleWidth) paddle.width *= 2;              
            }
            else if(rand == 1) {
                if(paddle.width > defaultPaddleWidth/2) paddle.width /= 2;
                
            }
            else if(rand == 2) {
                if(paddle.lives < 3) paddle.lives++;
            }
            else if(rand == 3) {
                if(ballSpeed < 2*defaultBallSpeed) {
                    ballSpeed *= 2;
                    speedRatio = Math.sqrt((ballSpeed*ballSpeed) + (ballSpeed*ballSpeed));
                }
                
            }
            else if(rand == 4) {
                
            }
        }

        function drawLives() {
            var height = borderWidth/3;
            var gap = height/2;
            var lives = 0;

            ctx.beginPath();
            ctx.moveTo(canvas.width/2, 0);
            ctx.lineTo(canvas.width/2, canvas.height);
            ctx.stroke();
            ctx.closePath();

            ctx.beginPath();
            ctx.moveTo(0, canvas.height/2);
            ctx.lineTo(canvas.width, canvas.height/2);
            ctx.stroke();
            ctx.closePath();

            // lives = topPaddle.lives;
            // for(var i = 0; i <topPaddle.lives; i++) {
            //     ctx.beginPath();
            //     ctx.arc(canvas.width/2 + i*(gap+height), height, height/2, 0, Math.PI*2);
            //     ctx.fillStyle = topPaddle.colour;
            //     ctx.fill();
            //     ctx.stroke();
            //     ctx.closePath();
            // }

            //Top
            if(topPaddle.lives > 2) {
                ctx.beginPath();
                ctx.arc(canvas.width/2 - 2*height, height, height/2, 0, Math.PI*2);
                ctx.fillStyle = topPaddle.colour;
                ctx.fill();
                ctx.stroke();
                ctx.closePath();

                ctx.beginPath();
                ctx.arc(canvas.width/2, height, height/2, 0, Math.PI*2);
                ctx.fillStyle = topPaddle.colour;
                ctx.fill();
                ctx.stroke();
                ctx.closePath();

                ctx.beginPath();
                ctx.arc(canvas.width/2 + 2*height, height, height/2, 0, Math.PI*2);
                ctx.fillStyle = topPaddle.colour;
                ctx.fill();
                ctx.stroke();
                ctx.closePath();
            }
            else if(topPaddle.lives > 1) {
                ctx.beginPath();
                ctx.arc(canvas.width/2 - height, height, height/2, 0, Math.PI*2);
                ctx.fillStyle = topPaddle.colour;
                ctx.fill();
                ctx.stroke();
                ctx.closePath();

                ctx.beginPath();
                ctx.arc(canvas.width/2 + height, height, height/2, 0, Math.PI*2);
                ctx.fillStyle = topPaddle.colour;
                ctx.fill();
                ctx.stroke();
                ctx.closePath();
            }
            else if(topPaddle.lives > 0) {
                ctx.beginPath();
                ctx.arc(canvas.width/2, height, height/2, 0, Math.PI*2);
                ctx.fillStyle = topPaddle.colour;
                ctx.fill();
                ctx.stroke();
                ctx.closePath();
            }

            //Left
            if (leftPaddle.lives > 2) {
                ctx.beginPath();
                ctx.arc(height, canvas.height/2 - 2*height, height/2, 0, Math.PI*2);
                ctx.fillStyle = leftPaddle.colour;
                ctx.fill();
                ctx.stroke();
                ctx.closePath();

                ctx.beginPath();
                ctx.arc(height, canvas.height/2, height/2, 0, Math.PI*2);
                ctx.fillStyle = leftPaddle.colour;
                ctx.fill();
                ctx.stroke();
                ctx.closePath();

                ctx.beginPath();
                ctx.arc(height, canvas.height/2 + 2*height, height/2, 0, Math.PI*2);
                ctx.fillStyle = leftPaddle.colour;
                ctx.fill();
                ctx.stroke();
                ctx.closePath();
            }
            else if(leftPaddle.lives > 1) {
                ctx.beginPath();
                ctx.arc(height, canvas.height/2 - height, height/2, 0, Math.PI*2);
                ctx.fillStyle = leftPaddle.colour;
                ctx.fill();
                ctx.stroke();
                ctx.closePath();

                ctx.beginPath();
                ctx.arc(height, canvas.height/2 + height, height/2, 0, Math.PI*2);
                ctx.fillStyle = leftPaddle.colour;
                ctx.fill();
                ctx.stroke();
                ctx.closePath();
            }
            else if(leftPaddle.lives > 0) {
                ctx.beginPath();
                ctx.arc(height, canvas.height/2, height/2, 0, Math.PI*2);
                ctx.fillStyle = leftPaddle.colour;
                ctx.fill();
                ctx.stroke();
                ctx.closePath();
            }

            //Right
            if (rightPaddle.lives > 2) {
                ctx.beginPath();
                ctx.arc(canvas.width - height, canvas.height/2 - 2*height, height/2, 0, Math.PI*2);
                ctx.fillStyle = rightPaddle.colour;
                ctx.fill();
                ctx.stroke();
                ctx.closePath();

                ctx.beginPath();
                ctx.arc(canvas.width - height, canvas.height/2, height/2, 0, Math.PI*2);
                ctx.fillStyle = rightPaddle.colour;
                ctx.fill();
                ctx.stroke();
                ctx.closePath();

                ctx.beginPath();
                ctx.arc(canvas.width - height, canvas.height/2 + 2*height, height/2, 0, Math.PI*2);
                ctx.fillStyle = rightPaddle.colour;
                ctx.fill();
                ctx.stroke();
                ctx.closePath();
            }
            else if(rightPaddle.lives > 1) {
                ctx.beginPath();
                ctx.arc(canvas.width - height, canvas.height/2 - height, height/2, 0, Math.PI*2);
                ctx.fillStyle = rightPaddle.colour;
                ctx.fill();
                ctx.stroke();
                ctx.closePath();

                ctx.beginPath();
                ctx.arc(canvas.width - height, canvas.height/2 + height, height/2, 0, Math.PI*2);
                ctx.fillStyle = rightPaddle.colour;
                ctx.fill();
                ctx.stroke();
                ctx.closePath();
            }
            else if(rightPaddle.lives > 0) {
                ctx.beginPath();
                ctx.arc(canvas.width - height, canvas.height/2, height/2, 0, Math.PI*2);
                ctx.fillStyle = rightPaddle.colour;
                ctx.fill();
                ctx.stroke();
                ctx.closePath();
            }

            //Bottom
            if (bottomPaddle.lives > 2) {
                ctx.beginPath();
                ctx.arc(canvas.width/2 - 2*height, canvas.height - height, height/2, 0, Math.PI*2);
                ctx.fillStyle = bottomPaddle.colour;
                ctx.fill();
                ctx.stroke();
                ctx.closePath();

                ctx.beginPath();
                ctx.arc(canvas.width/2, canvas.height - height, height/2, 0, Math.PI*2);
                ctx.fillStyle = bottomPaddle.colour;
                ctx.fill();
                ctx.stroke();
                ctx.closePath();

                ctx.beginPath();
                ctx.arc(canvas.width/2 + 2*height, canvas.height - height, height/2, 0, Math.PI*2);
                ctx.fillStyle = bottomPaddle.colour;
                ctx.fill();
                ctx.stroke();
                ctx.closePath();
            }
            else if(bottomPaddle.lives > 1) {
                ctx.beginPath();
                ctx.arc(canvas.width/2 - height, canvas.height - height, height/2, 0, Math.PI*2);
                ctx.fillStyle = bottomPaddle.colour;
                ctx.fill();
                ctx.stroke();
                ctx.closePath();

                ctx.beginPath();
                ctx.arc(canvas.width/2 + height, canvas.height - height, height/2, 0, Math.PI*2);
                ctx.fillStyle = bottomPaddle.colour;
                ctx.fill();
                ctx.stroke();
                ctx.closePath();
            }
            else if(bottomPaddle.lives > 0) {
                ctx.beginPath();
                ctx.arc(canvas.width/2, canvas.height - height, height/2, 0, Math.PI*2);
                ctx.fillStyle = bottomPaddle.colour;
                ctx.fill();
                ctx.stroke();
                ctx.closePath();
            }
        }



        function changeColour(ball) {
            if( ball.colour ==  "#000000") {
                ball.colour = "#FFFFFF";
            }
            else{
                ball.colour = "#000000";
            }
        }

        function drawPaddle() {
            //bottom
            if(bottomPaddle.lives > 0) {
                ctx.beginPath();
                ctx.rect(bottomPaddle.x, canvas.height-borderWidth-paddleHeight, bottomPaddle.width, paddleHeight);
                ctx.fillStyle = bottomPaddle.colour;
                ctx.fill();
                ctx.closePath();

                ctx.beginPath();
                ctx.rect(bottomPaddle.x, canvas.height-borderWidth-paddleHeight, bottomPaddle.width, paddleHeight);
                ctx.stroke();
                ctx.closePath();
            }
            else {
                ctx.beginPath();
                ctx.rect(borderWidth + paddleHeight, canvas.height-borderWidth-paddleHeight, canvas.width - 2*borderWidth - 2*paddleHeight, paddleHeight);
                ctx.fillStyle = bottomPaddle.colour;
                ctx.fill();
                ctx.closePath();

                ctx.beginPath();
                ctx.rect(borderWidth + paddleHeight, canvas.height-borderWidth-paddleHeight, canvas.width - 2*borderWidth - 2*paddleHeight, paddleHeight);
                ctx.stroke();
                ctx.closePath();
            }
            

            //top
            if(topPaddle.lives > 0) {
                ctx.beginPath();
                ctx.rect(topPaddle.x, borderWidth, topPaddle.width, paddleHeight);
                ctx.fillStyle = topPaddle.colour;
                ctx.fill();
                ctx.closePath();

                ctx.beginPath();
                ctx.rect(topPaddle.x, borderWidth, topPaddle.width, paddleHeight);
                ctx.stroke();
                ctx.closePath();
            }
            else {
                ctx.beginPath();
                ctx.rect(borderWidth + paddleHeight, borderWidth, canvas.width - 2*borderWidth - 2*paddleHeight, paddleHeight);
                ctx.fillStyle = topPaddle.colour;
                ctx.fill();
                ctx.closePath();

                ctx.beginPath();
                ctx.rect(borderWidth + paddleHeight, borderWidth, canvas.width - 2*borderWidth - 2*paddleHeight, paddleHeight);
                ctx.stroke();
                ctx.closePath();
            }
            

            //left
            if(leftPaddle.lives > 0) {
                ctx.beginPath();
                ctx.rect(borderWidth, leftPaddle.y, paddleHeight, leftPaddle.width);
                ctx.fillStyle = leftPaddle.colour;
                ctx.fill();
                ctx.closePath();

                ctx.beginPath();
                ctx.rect(borderWidth, leftPaddle.y, paddleHeight, leftPaddle.width);
                ctx.stroke();
                ctx.closePath();
            }
            else {
                ctx.beginPath();
                ctx.rect(borderWidth, borderWidth + paddleHeight, paddleHeight, canvas.height - 2*borderWidth - 2*paddleHeight);
                ctx.fillStyle = leftPaddle.colour;
                ctx.fill();
                ctx.closePath();

                ctx.beginPath();
                ctx.rect(borderWidth, borderWidth + paddleHeight, paddleHeight, canvas.height - 2*borderWidth - 2*paddleHeight);
                ctx.stroke();
                ctx.closePath();
            }
            
            

            //right
            if(rightPaddle.lives > 0) {
                ctx.beginPath();
                ctx.rect(canvas.width - paddleHeight - borderWidth, rightPaddle.y, paddleHeight, rightPaddle.width);
                ctx.fillStyle = rightPaddle.colour;
                ctx.fill();
                ctx.closePath();

                ctx.beginPath();
                ctx.rect(canvas.width - paddleHeight - borderWidth, rightPaddle.y, paddleHeight, rightPaddle.width);
                ctx.stroke();
                ctx.closePath();
            }
            else {
                ctx.beginPath();
                ctx.rect(canvas.width - paddleHeight - borderWidth, borderWidth + paddleHeight, paddleHeight, canvas.height - 2*borderWidth - 2*paddleHeight);
                ctx.fillStyle = rightPaddle.colour;
                ctx.fill();
                ctx.closePath();

                ctx.beginPath();
                ctx.rect(canvas.width - paddleHeight - borderWidth, borderWidth + paddleHeight, paddleHeight, canvas.height - 2*borderWidth - 2*paddleHeight);
                ctx.stroke();
                ctx.closePath();
            }
        }
        

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if(randResizeToggle == true) {
                
                resizeCanvas();
                randResizeToggle = false;
            }

            //Show positions
            document.getElementById("ballDx").innerHTML = Math.round(ball1.dx * 100) / 100;
            document.getElementById("ballDy").innerHTML = Math.round(ball1.dy * 100) / 100;

            
            drawLives();
            drawPowerup(powerup1);
            drawPowerup(powerup2);

            powerupCollision(ball1, powerup1);
            powerupCollision(ball1, powerup2);


            drawBorder();
            drawBall(ball1);
            drawPaddle();

            // Paddle collision checks           
            //Bottom check
            bottomCollision(ball1);

            //Left check
            leftCollision(ball1);

            //Top check
            topCollision(ball1);

            //Right  check
            rightCollision(ball1);

            //Move paddles
            //Bottom player
            if(bottomPaddle.rightPress && bottomPaddle.x < canvas.width-bottomPaddle.width-borderWidth-paddleHeight) {
                bottomPaddle.x += paddleSpeed;
            }
            else if(bottomPaddle.leftPress && bottomPaddle.x > borderWidth + paddleHeight) {
                bottomPaddle.x -= paddleSpeed;
                
            }

            //Top player
            if(topPaddle.rightPress && topPaddle.x < canvas.width-topPaddle.width-borderWidth-paddleHeight) {
                //alert('here');
                topPaddle.x += paddleSpeed;
            }
            else if(topPaddle.leftPress && topPaddle.x > borderWidth + paddleHeight) {               
                topPaddle.x -= paddleSpeed;
            }

            //Left player
            if(leftPaddle.upPress && leftPaddle.y > borderWidth + paddleHeight) {  
                leftPaddle.y -= paddleSpeed;
            }
            else if(leftPaddle.downPress && leftPaddle.y < canvas.height-leftPaddle.width-borderWidth-paddleHeight) {
                leftPaddle.y += paddleSpeed;
            }

            //Right player
            if(rightPaddle.upPress && rightPaddle.y > borderWidth + paddleHeight) {
                rightPaddle.y -= paddleSpeed;
            }
            else if(rightPaddle.downPress && rightPaddle.y < canvas.height-rightPaddle.width-borderWidth-paddleHeight) {
                rightPaddle.y += paddleSpeed;
            }

            //Move ball1
            ball1.x += ball1.dx;
            ball1.y += ball1.dy;
            requestAnimationFrame(draw);
        }

        draw();


        /////////////////////////////////////////////////////// Collision Functions //////////////////////////////////////////////////////////////////

        function powerupCollision(ball, powerup) {
            //alert('here');
            
            if(ball.x + ball.dx > powerup.x - ballRadius
            && ball.x + ball.dx < powerup.x + powerup.size + ballRadius
            && ball.y + ball.dy > powerup.y - ballRadius
            && ball.y + ball.dy < powerup.y + powerup.size + ballRadius) {
                var player = ball.owner;
                document.getElementById("status").innerHTML = "Powerup Owner: " + player;
                //alert('collision');
                //alert('player :' + player);
                powerup.active = false;
                givePowerup(ball);
                drawPowerup(powerup);
                ball.owner = 'none';
            }
        }


        function bottomCollision(ball) {
            if(ball.y + ball.dy > canvas.height-borderWidth-ballRadius-paddleHeight) { 
                if(bottomPaddle.lives == 0) {
                    ball.dy = -ball.dy;
                    document.getElementById("status").innerHTML = "Bottom Paddle: Wall";
                    changeColour(ball); 
                }

                //Check if ball has collided with paddle
                if(ball.x + ball.dx > bottomPaddle.x - ballRadius
                && ball.x + ball.dx < bottomPaddle.x + bottomPaddle.width + ballRadius
                && ball.y + ball.dy < canvas.height - borderWidth + ballRadius)
                {
                    ball.owner = 'bottom';
                    //Check if it rebounds on top
                    if(ball.x + ball.dx > bottomPaddle.x - (ballRadius/2) 
                        && ball.x + ball.dx < bottomPaddle.x + bottomPaddle.width + (ballRadius/2) 
                        && ball.y + ball.dy < canvas.height - borderWidth - paddleHeight) {
                        //Ball direction should only change once
                        if(Math.sign(ball.dy) == 1)
                        {
                            if(relativeAngleReboundToggle == true) {
                                if(ball.x < bottomPaddle.x + bottomPaddle.width/2) {    //Left side of paddle
                                    var angleMultiplier = (ball.x - (bottomPaddle.x - ballRadius/2))/(bottomPaddle.width/2 + ballRadius/2);
                                    var angle = angleMultiplier * (Math.PI/2);
                                    document.getElementById("status").innerHTML = angleMultiplier;
                                    ball.dy = -(speedRatio * Math.sin(angle));
                                    var sign = Math.sign(ball.dx);
                                    if(sign == 0) sign = -1; 
                                    ball.dx = sign * (speedRatio * Math.cos(angle));
                                }
                                else if (ball.x > bottomPaddle.x + bottomPaddle.width/2) {  //Right side of paddle
                                    var angleMultiplier = 1-(ball.x - (bottomPaddle.x + bottomPaddle.width/2))/(bottomPaddle.width/2 + ballRadius/2);
                                    var angle = angleMultiplier * (Math.PI/2);
                                    document.getElementById("status").innerHTML = angleMultiplier;
                                    ball.dy = Math.round(-(speedRatio * Math.sin(angle)));
                                    var sign = Math.sign(ball.dx);
                                    if(sign == 0) sign = 1;
                                    ball.dx = Math.round(sign * (speedRatio * Math.cos(angle)));
                                }
                                else {  //Unlikely occurance of it being perfectly in the middle
                                    ball.dy = -speedRatio
                                    ball.dx = 0;
                                }
                            }
                            else {
                                ball.dy = -ball.dy;
                                document.getElementById("status").innerHTML = "Bottom Paddle: Top";
                                changeColour(ball);
                            }
                            
                        }
                    }
                    else{
                        //Left side
                        if(ball.x + ball.dx > bottomPaddle.x - ballRadius && ball.x + ball.dx < bottomPaddle.x) {
                            document.getElementById("status").innerHTML = "Bottom Paddle: Left";
                            if(Math.sign(ball.dx) == 1) {
                                ball.dx = -ball.dx;
                                changeColour(ball);
                            }                            
                        }
                        //Right side
                        else if(ball.x + ball.dx < bottomPaddle.x + bottomPaddle.width + ballRadius && ball.x + ball.dx > bottomPaddle.x + bottomPaddle.width) {
                            document.getElementById("status").innerHTML = "Bottom Paddle: Right";
                            if(Math.sign(ball.dx) == -1) {
                                ball.dx = -ball.dx;
                                changeColour(ball);
                            } 
                        }
                    }
                    
                    
                }
                //Otherwise player missed
                else{
                    if(ball.y > canvas.height) {
                        //Take off a life
                        bottomPaddle.lives--;

                        //Reset ball
                        ball.initialPos = true;

                        ball.x = canvas.width/2;
                        ball.y = canvas.height*4/5;
                        ball.dx = 0;
                        ball.dy = -speedRatio;
                    //bottomPaddleX = (canvas.width-paddleWidth)/2;
                    }
                }
            }
        }        

        function rightCollision(ball) {
            if(ball.x + ball.dx > canvas.height-borderWidth-ballRadius-paddleHeight) { 
                if(rightPaddle.lives == 0) {
                    ball.dx = -ball.dx;
                    document.getElementById("status").innerHTML = "Right Paddle: Wall";
                    changeColour(ball);
                }

                //Check if ball has collided with paddle
                if(ball.y + ball.dy > rightPaddle.y - ballRadius
                && ball.y + ball.dy < rightPaddle.y + rightPaddle.width + ballRadius
                && ball.x + ball.dx < canvas.height - borderWidth + ballRadius)
                {
                    ball.owner = 'right';
                    //Check if it rebounds left side
                    if(ball.y + ball.dy > rightPaddle.y - (ballRadius/2) 
                        && ball.y + ball.dy < rightPaddle.y + rightPaddle.width + (ballRadius/2) 
                        && ball.x + ball.dx < canvas.height - borderWidth - paddleHeight) {
                        //Ball direction should only change once
                        if(Math.sign(ball.dx) == 1)
                        {
                            if(relativeAngleReboundToggle == true) {
                                if(ball.y < rightPaddle.y + rightPaddle.width/2) {     //Top half of paddle
                                    var angleMultiplier = (ball.y - (rightPaddle.y - ballRadius/2)) / (rightPaddle.width/2 + ballRadius/2);
                                    var angle = angleMultiplier * (Math.PI/2);
                                    document.getElementById("status").innerHTML = angleMultiplier;
                                    ball.dx = -(speedRatio * Math.sin(angle));
                                    var sign = Math.sign(ball.dy);
                                    if(sign == 0) sign = -1;
                                    ball.dy = sign * (speedRatio * Math.cos(angle));
                                }
                                else if(ball.y > rightPaddle.y + rightPaddle.width/2) {   //Bottom half of paddle
                                    var angleMultiplier = 1-((ball.y - (rightPaddle.y + rightPaddle.width/2)) / (rightPaddle.width/2 + ballRadius/2));
                                    var angle = angleMultiplier * (Math.PI/2);
                                    document.getElementById("status").innerHTML = angleMultiplier;
                                    ball.dx = -(speedRatio * Math.sin(angle));
                                    var sign = Math.sign(ball.dy);
                                    if(sign == 0) sign = 1;
                                    ball.dy = sign * (speedRatio * Math.cos(angle));
                                }
                                else {
                                    ball.dy = 0;
                                    ball.dx = -speedRatio;
                                }
                            }
                            else {
                                ball.dx = -ball.dx;
                                document.getElementById("status").innerHTML = "Right Paddle: Side";
                                changeColour(ball);
                            }
                            
                        }
                    }
                    else{
                        //Top side
                        if(ball.y + ball.dy > rightPaddle.y - ballRadius && ball.y + ball.dy < rightPaddle.y) {
                            document.getElementById("status").innerHTML = "Right Paddle: Top";
                            if(Math.sign(ball.dy) == 1) {
                                ball.dy = -ball.dy;
                                changeColour(ball);
                            }                            
                        }
                        //Bottom side
                        else if(ball.y + ball.dy < rightPaddle.y + rightPaddle.width + ballRadius && ball.y + ball.dy > rightPaddle.y + rightPaddle.width) {
                            document.getElementById("status").innerHTML = "Right Paddle: Bottom";
                            if(Math.sign(ball.dy) == -1) {
                                ball.dy = -ball.dy;
                                changeColour(ball);
                            } 
                        }
                    }
                    
                    
                }
                //Otherwise player missed
                else{
                    if(ball.x > canvas.height) {
                        //Take off a life
                        rightPaddle.lives--;

                        //Reset ball
                        ball.initialPos = true;

                        ball.x = canvas.width/2;
                        ball.y = canvas.height*4/5;
                        ball.dx = 0;
                        ball.dy = -speedRatio;
                    //bottomPaddleX = (canvas.width-paddleWidth)/2;
                    }
                }
            }
        } 
        
        function leftCollision(ball) {
            if(ball.x + ball.dx < borderWidth + paddleHeight + ballRadius) {    
                if(leftPaddle.lives == 0) {
                    ball.dx = -ball.dx;
                    changeColour(ball);
                    document.getElementById("status").innerHTML = "Left Paddle: Wall";
                }           

                //Check if ball has collided with paddle
                if(ball.y + ball.dy > leftPaddle.y - ballRadius
                && ball.y + ball.dy < leftPaddle.y + leftPaddle.width + ballRadius
                && ball.x + ball.dx > borderWidth - ballRadius) 
                { 
                    ball.owner = 'left';
                    //Check if it rebounds on right side
                    if(ball.y + ball.dy > leftPaddle.y - (ballRadius/2)
                    && ball.y + ball.dy < leftPaddle.y + leftPaddle.width + (ballRadius/2)
                    && ball.x + ball.dx > borderWidth + paddleHeight)
                    {
                        if(Math.sign(ball.dx) == -1)
                        {
                            if(relativeAngleReboundToggle == true) {
                                if(ball.y < leftPaddle.y + leftPaddle.width/2) {      //Top half of paddle
                                    var angleMultiplier = (ball.y - (leftPaddle.y - ballRadius/2)) / (leftPaddle.width/2 + ballRadius/2);
                                    var angle = angleMultiplier * (Math.PI/2);
                                    document.getElementById("status").innerHTML = angleMultiplier;
                                    ball.dx = (speedRatio * Math.sin(angle));
                                    var sign = Math.sign(ball.dy);
                                    if(sign == 0) sign = -1;
                                    ball.dy = sign * (speedRatio * Math.cos(angle));
                                }
                                else if(ball.y > leftPaddle.y + leftPaddle.width/2) {   //Bottom half of paddle
                                    var angleMultiplier = 1-((ball.y - (leftPaddle.y + leftPaddle.width/2)) / (leftPaddle.width/2 + ballRadius/2));
                                    var angle = angleMultiplier * (Math.PI/2);
                                    document.getElementById("status").innerHTML = angleMultiplier;
                                    ball.dx = (speedRatio * Math.sin(angle));
                                    var sign = Math.sign(ball.dy);
                                    if(sign == 0) sign = 1;
                                    ball.dy = sign * (speedRatio * Math.cos(angle));
                                }
                                else {
                                    ball.dy = 0;
                                    ball.dx = -speedRatio;
                                }
                            }
                            else {
                                ball.dx = -ball.dx;
                                changeColour(ball);
                                document.getElementById("status").innerHTML = "Left Paddle: Side";
                            }
                            
                        }
                    }
                    else {
                        //Top
                        if(ball.y + ball.dy > leftPaddle.y - ballRadius && ball.y + ball.dy < leftPaddle.y) {
                            if(Math.sign(ball.dy) == 1)
                            {
                                ball.dy = -ball.dy;
                                changeColour(ball);
                                document.getElementById("status").innerHTML = "Left Paddle: Top";
                            }                            
                        }
                        //Bottom
                        else if(ball.y + ball.dy < leftPaddle.y + leftPaddle.width + ballRadius && ball.y + ball.dy > leftPaddle.y + leftPaddle.width) {
                            if(Math.sign(ball.dy) == -1)
                            {
                                ball.dy = -ball.dy;
                                changeColour(ball);
                                document.getElementById("status").innerHTML = "Left Paddle: Bottom";
                            }
                        }

                    }

                }
                // Otherwise player missed
                else {
                    if(ball.x < 0) {
                        //Take off a life
                        leftPaddle.lives--;

                        //Reset ball
                        ball.initialPos = true;

                        ball.x = canvas.width/2;
                        ball.y = canvas.height*4/5;
                        ball.dx = 0;
                        ball.dy = -speedRatio;
                    //bottomPaddleX = (canvas.width-paddleWidth)/2;
                    }                   
                }               
            }
        }

        function topCollision(ball) {
            if(ball.y + ball.dy < borderWidth + paddleHeight + ballRadius) {
                if(topPaddle.lives == 0) {
                    ball.dy = -ball.dy;
                    changeColour(ball);
                    document.getElementById("status").innerHTML = "Top Paddle: Wall";
                }
                
                //Check if ball has collided with paddle
                if(ball.x + ball.dx > topPaddle.x - ballRadius
                && ball.x + ball.dx < topPaddle.x + topPaddle.width + ballRadius
                && ball.y + ball.dy > borderWidth - ballRadius) 
                { 
                    //alert(topPaddle.x);
                    ball.owner = 'top';
                    //Check if it rebounds on bottom
                    if(ball.x + ball.dx > topPaddle.x - (ballRadius/2)
                    && ball.x + ball.dx < topPaddle.x + topPaddle.width + (ballRadius/2)
                    && ball.y + ball.dy > borderWidth + paddleHeight)
                    {
                        
                        if(Math.sign(ball.dy) == -1)
                        {
                            if(relativeAngleReboundToggle == true) {
                                if(ball.x < topPaddle.x + topPaddle.width/2) {    //Left side of paddle
                                    var angleMultiplier = (ball.x - (topPaddle.x - ballRadius/2))/(topPaddle.width/2 + ballRadius/2);
                                    var angle = angleMultiplier * (Math.PI/2);
                                    document.getElementById("status").innerHTML = angleMultiplier;
                                    ball.dy = (speedRatio * Math.sin(angle));
                                    var sign = Math.sign(ball.dx);
                                    if(sign == 0) sign = -1; 
                                    ball.dx = sign * (speedRatio * Math.cos(angle));
                                }
                                else if (ball.x > topPaddle.x + topPaddle.width/2) {  //Right side of paddle
                                    var angleMultiplier = 1-(ball.x - (topPaddle.x + topPaddle.width/2))/(topPaddle.width/2 + ballRadius/2);
                                    var angle = angleMultiplier * (Math.PI/2);
                                    document.getElementById("status").innerHTML = angleMultiplier;
                                    ball.dy = (speedRatio * Math.sin(angle));
                                    var sign = Math.sign(ball.dx);
                                    if(sign == 0) sign = 1;
                                    ball.dx = sign * (speedRatio * Math.cos(angle));
                                }
                                else {  //Unlikely occurance of it being perfectly in the middle
                                    ball.dy = -speedRatio
                                    ball.dx = 0;
                                }
                            }
                            else {
                                ball.dy = -ball.dy;
                                changeColour(ball);
                                document.getElementById("status").innerHTML = "Top Paddle: Bottom";
                            }
                            
                        }
                    }
                    else {
                        //Top
                        if(ball.x + ball.dx > topPaddle.x - ballRadius && ball.x + ball.dx < topPaddle.x) {
                            if(Math.sign(ball.dx) == 1)
                            {
                                ball.dx = -ball.dx;
                                changeColour(ball);
                                document.getElementById("status").innerHTML = "Top Paddle: Left";
                            }                            
                        }
                        //Bottom
                        else if(ball.x + ball.dx < topPaddle.x + topPaddle.width + ballRadius && ball.x + ball.dx > topPaddle.x + topPaddle.width) {
                            if(Math.sign(ball.dx) == -1)
                            {
                                ball.dx = -ball.dx;
                                changeColour(ball);
                                document.getElementById("status").innerHTML = "Top Paddle: Right";
                            }
                        }

                    }

                }
                // Otherwise player missed
                else {
                    if(ball.y < 0) {
                        //Take off a life
                        topPaddle.lives--;

                        //Reset ball
                        ball.initialPos = true;

                        ball.x = canvas.width/2;
                        ball.y = canvas.height*4/5;
                        ball.dx = 0;
                        ball.dy = -speedRatio;
                    //bottomPaddleX = (canvas.width-paddleWidth)/2;
                    }                   
                }               
            }
        }
    </script>

</body>
</html>
